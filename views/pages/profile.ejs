<!DOCTYPE html>
<html data-theme="<%= theme ?? 'purple' %>" data-font="<%= font ?? 'Lato' %>" lang="en">

<head>
  <%- include('../partials/head') %>
  <% const nameParts = account.name.split(' '); %>
  <% const titleName = nameParts.length > 1 ? `${nameParts[0]} ${nameParts[1][0]}.` : nameParts[0]; %>
  <title><%= titleName %> on 2k17 Platform</title>
  <link rel="stylesheet" href="/styles/css/profile.css">

  <meta property="og:title" content="<%= account.name %> on 2k17 Platform">
  <meta property="og:description" content="2k17 Platform">
  <meta property="og:image" content="<%= account.profile || '/images/user.png' %>">
  <meta property="og:url" content="/<%= account.username %>">
  <meta property="og:type" content="website">
</head>

<body>
  <%- include('../partials/loader') %>
  <%- include('../partials/navbar') %>
  <div class="profile-page loader-after-body" style="display: none;">
    <div class="cover-photo" style="background: linear-gradient(rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.4)), url(<%= account.coverPhoto || '/images/jnv-bg-1.jpg' %>) center center / cover no-repeat;">
    </div>

    <div class="profile-info-container">
      <div class="profile-photo">
        <img src="<%= account.profile || '/images/user.png' %>" alt="Profile">
      </div>
      <div class="user-details">
        <p class="name"><%= account.name %></p>
        <p class="username"><%- account.username ? `@${account.username}` : 'Not registered' %></p>

        <% if(account.bio){ %>
        <p class="bio"><%- account.bio %></p>
        <% } %>

        <div class="badges-container">
          <% if (account.earnedBadges && account.earnedBadges.length > 0) { %>
          <% account.earnedBadges.forEach(earned => { %>
          <div class="badge-item" onclick="openBadgesTab()" data-tab="badges" title="<%= earned.badge.description %>">
            <img src="<%- earned.badge.icon %>">
          </div>
          <% }) %>
          <% } else { %>
          <p style="color: var(--text-muted)">No badges earned yet.</p>
          <% } %>
        </div>

        <div class="action-buttons">
          <% if(account.verified && user && user._id.toString() === account._id.toString()){ %>
          <button class="action-btn primary" onclick="window.location.href = '/profile/edit'"><span class="fal fa-user-pen"></span> Edit</button>
          <% } %>
          <% if (account.email && account?.settings?.privacy?.email) { %>
          <button class="action-btn" onclick="window.location.href = 'mailto:<%= account.email %>'"><span class="fal fa-envelope"></span>Email</button>
          <% } %>
          <% if (account.phone && account?.settings?.privacy?.phone) { %>
          <button class="action-btn" onclick="window.location.href= 'tel:<%= account.phone %>'"><span class="fal fa-phone"></span>Call</button>
          <% } %>
        </div>
      </div>
    </div>

    <div class="tabs-container">
      <div class="tabs">
        <button class="tab-btn active" data-tab="posts" id="posts-tab"><span class="helper-text">POSTS</span></button>
        <button class="tab-btn" data-tab="memories" id="memories-tab"><span class="helper-text">MEMORIES</span></button>
        <% if(user){ %>
        <button class="tab-btn" data-tab="about" id="about-tab"><span class="helper-text">ABOUT</span></button>
        <% } else { %>
        <button class="tab-btn" data-tab="about" id="about-tab" onclick="showLoginBanner()"><span class="fal fa-address-card"></span><span class="helper-text">ABOUT</span></button>
        <% } %>
        <button class="tab-btn" data-tab="badges" id="badges-tab"><span class="helper-text"><span class="fal fa-award"></span></span></button>
      </div>

      <div class="tab-content">
        <div class="tab-panel active" id="posts">
          <% if (posts.length === 0) { %>
          <p class="empty-msg">No posts yet.</p>
          <% } else { %>
          <div class="posts">
            <% posts.forEach(post => { %>
            <div class="post" style="border-top: none;" id="post-<%= post._id %>" ondblclick="toggleLike('<%= post._id %>')">
              <div class="user-info">
                <img src="<%= post.author.profile %>" alt="" class="user-profile">
                <div class="user-info-helper">
                  <span class="name">
                    <%= post.author.name %>
                  </span><br>
                  <span class="username">@<%= post.author.username %> (<%= post.timeAgo %>)</span>
                </div>
              </div>
              <div class="post-data">
                <%- post.text %>
                <% if(post.media !== undefined && post.media !== null && post.media.url !== undefined && post.media.url !== null){ %>
                <% if(post.media.type.startsWith('image')) { %>
                <img src="<%= post.media.url %>" alt="" class="post-img">
                <% } else if(post.media.type.startsWith('video')) { %>
                <video controls class="post-video">
                  <source src="<%= post.media.url %>" type="video/mp4">
                  Your browser does not support the video tag.
                </video>
                <% } %>
                <% } %>
              </div>
              <div class="post-buttons" style="padding: 2px 0">
                <% if(user) { %>
                <% var isLiked=post.likes.some(u=> u._id.toString() === user._id.toString()) %>
                <button class="like-btn" onclick="toggleLike('<%= post._id %>')" id="like-btn-<%=post._id %>">
                  <span class="<%- isLiked ? 'fas' : 'fal' %> fa-heart" id="like-icon-<%= post._id %>"></span>
                </button>
                <% } else { %>
                <button class="like-btn" onclick="showLoginBanner()" id="like-btn-<%=post._id %>">
                  <span class="fal fa-heart" id="like-icon-<%= post._id %>"></span>
                </button>
                <% } %>
                <% if(user) { %>
                <% const userReaction = post.reactions.find(r => r.user == user.id) %>
                <div class="reaction-buttons" id="reactions-<%= post._id %>">
                  <% ['ðŸ˜‚', 'ðŸ”¥', 'ðŸŽ‰'].forEach(emoji => { %>
                  <% const reactedClass = (userReaction && userReaction.reaction === emoji) ? 'reacted' : '' %>
                  <button class="reaction-emoji <%= reactedClass %>" data-emoji="<%= emoji %>" onclick="toggleReaction('<%= post._id %>', '<%= emoji %>')">
                    <%= emoji %>
                  </button>
                  <% }) %>
                </div>
                <% } else { %>
                <% ['ðŸ˜‚', 'ðŸ”¥', 'ðŸŽ‰'].forEach(emoji => { %>
                <button class="reaction-emoji" data-emoji="<%= emoji %>" onclick="alert('Please login to react to this post')">
                  <%= emoji %>
                </button>
                <% }) %>
                <% } %>
                <button class="comment-btn" onclick="loadComments('<%= post._id %>')" id="comment-btn-<%= post._id %>">
                  <span class="fal fa-message-lines"></span> <%- post.comments.length || '' %>
                </button>
                <div class="btns-right">
                  <button class="share-btn" onclick="sharePost(this)" data-text="See this post by <%= post.author.name %> on 2k17" data-title="2k17 Platform" data-media="<%= post.media ? post.media.url : '' %>" data-url="https://twok17.onrender.com/post/<%= post._id %>">
                    <span class="fal fa-share"></span>
                  </button>
                </div>
              </div>
              <% if(post.likes.length > 2) { %>
              <p class="extend-like-msg"><img src="<%-post.likes[1].profile || '/images/user.png'%>" alt="" class="user-profile"> Liked by &nbsp;<span onclick='window.location.href="/<%= post.likes[1].username%>"'><%-post.likes[1].username%></span>&nbsp; and <span style="margin: 0 3px;" onclick="openPostLikes('<%= post._id %>')"><%-post.likes.length - 1 %> others</span></p>
              <% } %>
            </div>
            <% }) %>

            <% if(!user) { %>
            <div class="login-box">
              <p>Please log in to see more posts.</p>
              <p><a href="/create-account" class="btn">Create Account</a> or <a href="/login" class="btn">Log In</a></p>
            </div>
            <% } %>
          </div>
          <% } %>
        </div>

        <div class="tab-panel" id="memories">
          <% if (memories.length === 0) { %>
          <p class="empty-msg"><span class="fal fa-image-slash"></span><br>No tagged memories found.<br>Go to <a href="/memories">Memories</a> to add some.</p>
          <% } else if(!user) { %>
          <div class="login-box">
            <p>Please log in to see memories of <%= account.name %>.</p>
            <p><a href="/create-account" class="btn">Create Account</a> or <a href="/login" class="btn">Log In</a></p>
          </div>
          <% } else { %>
          <div class="media-grid">
            <% memories.forEach(memory => { %>
            <div class="media-card" onclick="window.location.href= '/memories/file/<%= memory._id %>'">
              <div class="media-overlay">
                <div class="overlay-content">
                  <span><i class="fal fa-heart"></i> <%= memory.likes.length %></span>
                  <span><i class="fal fa-message"></i> <%= memory.comments.length %></span>
                </div>
              </div>
              <img src="<%= memory.thumbnail %>" alt="Media" />
            </div>
            <% }) %>
          </div>
          <% } %>
        </div>

        <% if(user) { %>
        <div class="tab-panel" id="about">
          <div class="about-section">
            <div class="about-card">
              <h3 class="about-heading">Basic Info</h3>
              <% if((account.settings?.privacy?.dob || user._id.toString() == account._id.toString())){ %>
              <div class="info-item" style="margin: 16px 0;">
                <i class="fal fa-cake-candles icon"></i>
                <div class="info-text">
                  <span class="label">Birthday</span>
                  <span class="value"><%= formatDOB(account.dob) %> <%- (!account.settings?.privacy?.dob && user._id.toString() == account._id.toString()) ? '<span class="grey-1">(Visible only to you)</span>' : '' %></span>
                </div>
              </div>
              <% }%>
              <div class="info-item">
                <i class="fal fa-calendar icon"></i>
                <div class="info-text">
                  <span class="label">Years in JNV</span>
                  <span class="value"><%= account.year %></span>
                </div>
              </div>
              <div class="info-item" style="margin-top: 16px">
                <i class="fal fa-user-clock icon" style="font-size: 17px"></i>
                <div class="info-text">
                  <span class="label">Platform join date</span>
                  <span class="value"><%= account.joinedAt.toLocaleString("en-IN", { day: 'numeric', month: 'long', year: 'numeric', timeZone: 'Asia/Kolkata' }) %></span>
                </div>
              </div>
            </div>

            <% const socialLinks = account.socialLinks; %>
            <% const hasLinks = socialLinks && Object.values(socialLinks).some(link => link); %>
            <% if (hasLinks) { %>
            <div class="about-card">
              <h3 class="about-heading">Social Links</h3>
              <% const iconMap = { instagram: 'fab fa-instagram', linkedin: 'fab fa-linkedin', github: 'fab fa-github', facebook: 'fab fa-facebook', other: 'fal fa-link' }; %>
              <% for (const [key, value] of Object.entries(socialLinks)) { %>
              <% if (value) { %>
              <a href="<%= value %>" target="_blank" class="social-link-item">
                <i class="<%= iconMap[key] || 'fal fa-link' %> icon"></i>
                <span class="value"><%= key.charAt(0).toUpperCase() + key.slice(1) %></span>
                <i class="fal fa-arrow-up-right-from-square link-arrow"></i>
              </a>
              <% } %>
              <% } %>
            </div>
            <% } %>

          </div>
        </div>
        <% } else { %>
        <div class="tab-panel" id="about">
          <div class="about-section">
            <p class="empty-msg" style="text-align: center;">
              <span class="fal fa-lock"></span><br>
              Please log in to see this information. <br><a href="/login">Login</a> or <a href="/create-account">Create account</a>
            </p>
          </div>
        </div>
        <% } %>

        <div class="tab-panel" id="badges">
          <div class="badges-section">
            <div class="badge-card">
              <h3 class="badge-heading">Badges earned</h3>
              <div class="badge-list">
                <% if (account.earnedBadges && account.earnedBadges.length > 0) { %>
                <% account.earnedBadges.forEach(earned => { %>
                <div class="badge-item">
                  <p class="icon">
                    <img src="<%- earned.badge.icon %>">
                  </p>
                  <div class="info-text">
                    <span class="name"><%= earned.badge.name %></span>
                    <span class="description"><%- earned.badge.description %></span>
                  </div>
                </div>
                <% }) } else { %>
                <p class="empty-msg" style="text-align: center;">
                  <span class="fal fa-award"></span><br>
                  No badges earned yet.
                </p>
                <% } %>
                <br>
                <span class="grey-1"><a href="/badges">Click here</a> to know more about badges.</span>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
    <div id="comments-popup">
      <div class="overlay" onclick="hidePopup()" id="overlay"></div>
      <div class="comments-box">
        <div class="heading">
          <p>Comments</p>
          <p class="close-icon fas fa-times" onclick="hidePopup()"></p>
        </div>
        <div class="comments-list" id="comments-list"></div>
        <% if(user) { %>
        <div class="input-area">
          <input id="new-comment" autocomplete="off" placeholder="Write a comment..." />
          <button type="button" id="newCommentBtn">Post</button>
        </div>
        <% } %>
      </div>
    </div>

    <div class="login-banner" id="login-banner">
      <div class="overlay"></div>
      <div class="login-required-box">
        <span onclick="hidePopup('login-banner')" class="fal fa-xmark"></span>
        <img src="<%= account.profile || '/images/user.png' %>" alt="" class="user-profile" />
        <p id="title"></p>
        <span class="grey-1">You must log in to do this.</span><br>
        <span class="grey-1">See much more about <%= account.name %><br>on 2k17 Platform.</span><br><br>
        <button class="signup-btn" onclick="window.location.href='/create-account'">Create account</button>
        <button class="login-btn" onclick="window.location.href='/login?url=/<%= account.username %>'">Log in</button>
      </div>
    </div>

    <div id="post-likes-popup">
      <div class="overlay" onclick="closePostLikes()"></div>
      <div class="post-likes-box">
        <div class="heading">
          <p class="title"><span class="fal fa-heart"></span> Likes on post</p>
          <p class="close-icon fal fa-xmark" onclick="closePostLikes()"></p>
        </div>
        <div class="post-likes-list" id="post-likes-list"></div>
      </div>
    </div>
    <script src="/js/profile.js"></script>
    <script src="/js/comment.js"></script>
</body>

</html>